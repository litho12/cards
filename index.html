<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wedding Store Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#4338ca',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <!-- Navbar -->
    <nav class="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fas fa-crown text-yellow-500 text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide">Admin Dashboard</h1>
                    <p class="text-xs text-green-400" id="connectionStatus"><i class="fas fa-wifi"></i> Connected: litho12/cards</p>
                </div>
            </div>
            <a href="index.html" target="_blank" class="text-sm bg-slate-700 hover:bg-slate-600 px-3 py-1 rounded transition">
                View Website <i class="fas fa-external-link-alt ml-1"></i>
            </a>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-5xl">
        
        <!-- Messages -->
        <div id="messageContainer" class="mb-6 fixed top-20 right-5 z-50 w-80"></div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Add Product -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
                    <h2 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2 flex items-center">
                        <i class="fas fa-plus-circle text-primary mr-2"></i> Add New Card
                    </h2>
                    
                    <form id="addCardForm" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Card Name</label>
                            <input type="text" id="cardName" placeholder="Ex: Royal Gold Invite" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition" required>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Price (â‚¹)</label>
                            <input type="number" id="cardPrice" placeholder="499" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition" required>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Category</label>
                            <select id="cardCategory" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition">
                                <option value="luxury">Luxury</option>
                                <option value="traditional">Traditional</option>
                                <option value="modern">Modern</option>
                                <option value="budget">Budget Friendly</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Card Image</label>
                            <label class="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                                <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                    <i class="fas fa-cloud-upload-alt text-2xl text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-500">Click to upload image</p>
                                </div>
                                <input id="file-upload" type="file" class="hidden" accept="image/*" />
                            </label>
                            <!-- Preview -->
                            <div id="previewContainer" class="hidden mt-2 relative">
                                <img id="imagePreview" src="" class="w-full h-32 object-cover rounded-lg border">
                                <button type="button" onclick="clearImage()" class="absolute top-1 right-1 bg-red-500 text-white rounded-full p-1 text-xs w-6 h-6 flex items-center justify-center">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-primary to-secondary hover:from-blue-700 hover:to-blue-800 text-white font-bold py-3 rounded-lg shadow-md transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                            Upload to GitHub
                        </button>
                    </form>
                </div>
            </div>

            <!-- Right Column: Product List -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md p-6 min-h-[500px]">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h2 class="text-lg font-bold text-gray-800">
                            <i class="fas fa-layer-group text-primary mr-2"></i> Live Inventory
                        </h2>
                        <button onclick="loadCurrentCards()" class="text-xs bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1.5 rounded-full transition">
                            <i class="fas fa-sync-alt mr-1"></i> Refresh
                        </button>
                    </div>

                    <div id="loadingIndicator" class="hidden text-center py-10">
                        <i class="fas fa-circle-notch fa-spin text-3xl text-primary"></i>
                        <p class="text-sm text-gray-500 mt-2">Fetching data from GitHub...</p>
                    </div>

                    <div id="cardsList" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Cards will load here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ðŸ›‘ FIXED CONFIGURATION ðŸ›‘
        // ==========================================
        
        const GITHUB_CONFIG = {
            token: "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", 
            owner: "litho12", 
            repo: "cards",
            branch: "main" 
        };

        // ==========================================
        // END CONFIGURATION
        // ==========================================

        let currentImageBase64 = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentCards();
        });

        // Image Handling
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showMessage("Image too large. Max 5MB allowed.", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                currentImageBase64 = e.target.result;
                document.getElementById('imagePreview').src = currentImageBase64;
                document.getElementById('previewContainer').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        });

        function clearImage() {
            document.getElementById('file-upload').value = '';
            currentImageBase64 = null;
            document.getElementById('previewContainer').classList.add('hidden');
        }

        // Upload Logic
        document.getElementById('addCardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentImageBase64) return showMessage("Please select an image first.", "error");
            
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';

            try {
                // 1. Prepare Data
                const cardId = Date.now().toString();
                const cleanName = document.getElementById('cardName').value.replace(/[^a-zA-Z0-9]/g, "_");
                const imagePath = `images/${cleanName}_${cardId}.jpg`;
                
                // 2. Upload Image
                showMessage("Uploading Image...", "info");
                const imageContent = currentImageBase64.split(',')[1];
                const imageUrl = await uploadToGitHub(imagePath, imageContent, `Image for ${cleanName}`);
                
                // 3. Update JSON
                showMessage("Updating Database...", "info");
                const newCard = {
                    id: cardId,
                    name: document.getElementById('cardName').value,
                    price: document.getElementById('cardPrice').value,
                    category: document.getElementById('cardCategory').value,
                    image: imageUrl, 
                    date: new Date().toISOString()
                };

                const currentFile = await fetchFile('cards.json');
                let cards = [];
                let sha = null;

                if (currentFile) {
                    cards = JSON.parse(atob(currentFile.content));
                    sha = currentFile.sha;
                }

                cards.unshift(newCard); // Add to top

                // Save JSON
                const jsonContent = btoa(unescape(encodeURIComponent(JSON.stringify(cards, null, 2))));
                await uploadToGitHub('cards.json', jsonContent, `Added card: ${newCard.name}`, sha);

                showMessage("Success! Card is live.", "success");
                
                // Reset Form
                document.getElementById('addCardForm').reset();
                clearImage();
                loadCurrentCards();

            } catch (error) {
                console.error(error);
                let msg = error.message;
                if(msg === "Not Found") {
                    msg = "Error: Repository 'cards' not found on GitHub. Please create it first!";
                }
                showMessage(msg, "error", 6000);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // GitHub API Functions
        async function uploadToGitHub(path, content, message, sha = null) {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
            const body = {
                message: message,
                content: content,
                branch: GITHUB_CONFIG.branch
            };
            if (sha) body.sha = sha;

            const res = await fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.message);
            }
            
            return `https://raw.githubusercontent.com/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${path}`;
        }

        async function fetchFile(path) {
            const url = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${path}`;
            const res = await fetch(url, {
                headers: { 
                    'Authorization': `token ${GITHUB_CONFIG.token}`,
                    'Cache-Control': 'no-cache'
                }
            });
            if (res.status === 404) return null;
            if (!res.ok) throw new Error("Failed to fetch file");
            return await res.json();
        }

        async function loadCurrentCards() {
            const list = document.getElementById('cardsList');
            const loader = document.getElementById('loadingIndicator');
            
            list.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                const file = await fetchFile('cards.json');
                loader.classList.add('hidden');
                
                if (!file) {
                    list.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">Repository found but empty. Add your first card!</div>`;
                    return;
                }

                const cards = JSON.parse(atob(file.content));
                
                if (cards.length === 0) {
                    list.innerHTML = `<div class="col-span-full text-center text-gray-400 py-10">No cards found.</div>`;
                    return;
                }

                list.innerHTML = cards.map(card => `
                    <div class="bg-white border border-gray-100 rounded-lg p-3 flex gap-3 hover:shadow-md transition group">
                        <img src="${card.image}" class="w-20 h-20 object-cover rounded-md bg-gray-50">
                        <div class="flex-1 flex flex-col justify-between">
                            <div>
                                <h4 class="font-bold text-gray-800 line-clamp-1">${card.name}</h4>
                                <div class="flex items-center justify-between mt-1">
                                    <span class="text-primary font-bold">â‚¹${card.price}</span>
                                    <span class="text-[10px] uppercase bg-gray-100 px-2 py-0.5 rounded text-gray-500">${card.category}</span>
                                </div>
                            </div>
                            <button onclick="deleteCard('${card.id}')" class="text-xs text-red-500 hover:text-red-700 font-medium text-left mt-2 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition">
                                <i class="fas fa-trash"></i> Remove Card
                            </button>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                loader.classList.add('hidden');
                console.error(error);
                list.innerHTML = `<div class="col-span-full text-center text-red-400">
                    <p class="font-bold">Error: Not Found</p>
                    <p class="text-sm text-gray-600 mt-1">Please make sure the repository <b>'cards'</b> exists in <b>'litho12'</b> account.</p>
                </div>`;
            }
        }

        async function deleteCard(id) {
            if (!confirm("Are you sure? This will remove the card from the website.")) return;

            try {
                showMessage("Deleting...", "info");
                const currentFile = await fetchFile('cards.json');
                const cards = JSON.parse(atob(currentFile.content));
                const newCards = cards.filter(c => c.id !== id);
                
                const jsonContent = btoa(unescape(encodeURIComponent(JSON.stringify(newCards, null, 2))));
                await uploadToGitHub('cards.json', jsonContent, `Deleted card ${id}`, currentFile.sha);
                
                showMessage("Card Deleted.", "success");
                loadCurrentCards();
            } catch (e) {
                showMessage("Delete failed: " + e.message, "error");
            }
        }

        function showMessage(msg, type = 'info', duration = 4000) {
            const container = document.getElementById('messageContainer');
            const colors = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            const div = document.createElement('div');
            div.className = `${colors} text-white px-4 py-3 rounded-lg shadow-lg mb-2 flex items-center gap-3 transform transition-all duration-300 translate-x-full`;
            div.innerHTML = `<i class="fas ${icon}"></i> <span class="text-sm font-medium">${msg}</span>`;
            
            container.appendChild(div);
            
            setTimeout(() => div.classList.remove('translate-x-full'), 10);
            
            setTimeout(() => {
                div.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => div.remove(), 300);
            }, duration);
        }
    </script>
</body>
</html>
